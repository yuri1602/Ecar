# Ğ‘Ğ¸Ğ·Ğ½ĞµÑ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¸ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ğ¸

## ğŸ“‹ ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑĞ¸

### 1ï¸âƒ£ Ğ¡ÑŠĞ·Ğ´Ğ°Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° Ğ·Ğ°Ñ€ÑĞ´Ğ½Ğ° ÑĞµÑĞ¸Ñ (Ğ¾Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€)

#### Flowchart

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Admin Ğ¾Ñ‚Ğ²Ğ°Ñ€Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ° "ĞĞ¾Ğ²Ğ¾ Ğ·Ğ°Ñ€ĞµĞ¶Ğ´Ğ°Ğ½Ğµ"             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ˜Ğ·Ğ±Ğ¸Ñ€Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ» Ğ¾Ñ‚ dropdown                    â”‚
â”‚ (Ğ¿Ğ¾ĞºĞ°Ğ·Ğ²Ğ°Ñ‚ ÑĞµ ÑĞ°Ğ¼Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğ¸)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ’ÑŠĞ²ĞµĞ¶Ğ´Ğ° Ğ´Ğ°Ğ½Ğ½Ğ¸:                                  â”‚
â”‚ â€¢ Ğ”Ğ°Ñ‚Ğ° Ğ¸ Ñ‡Ğ°Ñ Ğ½Ğ° Ğ·Ğ°Ñ€ĞµĞ¶Ğ´Ğ°Ğ½Ğµ (started_at)          â”‚
â”‚ â€¢ ĞšÑ€Ğ°Ğ¹ Ğ½Ğ° Ğ·Ğ°Ñ€ĞµĞ¶Ğ´Ğ°Ğ½Ğµ (ended_at)                  â”‚
â”‚ â€¢ kWh Ğ·Ğ°Ñ€ĞµĞ´ĞµĞ½Ğ¸                                  â”‚
â”‚ â€¢ ĞĞ±Ñ‰Ğ° Ñ†ĞµĞ½Ğ° (BGN)                               â”‚
â”‚ â€¢ Ğ¡Ñ‚Ğ°Ğ½Ñ†Ğ¸Ñ (Ğ¾Ğ¿Ñ†Ğ¸Ñ)                               â”‚
â”‚ â€¢ Ğ¢Ğ°Ñ€Ğ¸Ñ„Ğ° (Ğ¾Ğ¿Ñ†Ğ¸Ñ)                                â”‚
â”‚ â€¢ Ğ‘ĞµĞ»ĞµĞ¶ĞºĞ¸ (Ğ¾Ğ¿Ñ†Ğ¸Ñ)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸:                                      â”‚
â”‚ âœ“ ended_at >= started_at                        â”‚
â”‚ âœ“ kwh_charged > 0                               â”‚
â”‚ âœ“ price_total >= 0                              â”‚
â”‚ âœ“ Ğ”Ğ°Ñ‚Ğ° Ğ½Ğµ Ğµ Ğ² Ğ±ÑŠĞ´ĞµÑ‰ĞµÑ‚Ğ¾                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚               â”‚
            ĞĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾        Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾
                 â”‚               â”‚
                 â–¼               â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ ĞŸĞ¾ĞºĞ°Ğ·Ğ²Ğ° Ğ³Ñ€ĞµÑˆĞºĞ¸ â”‚  â”‚ Ğ—Ğ°Ğ¿Ğ¸ÑĞ²Ğ° Ğ² Ğ‘Ğ”:           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ charge_sessions       â”‚
                         â”‚ â€¢ status =              â”‚
                         â”‚   'pending_odometer'    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ ĞĞ°Ğ¼Ğ¸Ñ€Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¾Ñ‚Ğ¾       â”‚
                         â”‚ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚ÑŠÑ€Ğ°  â”‚
                         â”‚ Ğ·Ğ° Ñ‚Ğ¾Ğ·Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»       â”‚
                         â”‚ (last_known_km)         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ ĞĞ°Ğ¼Ğ¸Ñ€Ğ° Ğ²ÑĞ¸Ñ‡ĞºĞ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¸   â”‚
                         â”‚ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»Ğ¸, ÑĞ²ÑŠÑ€Ğ·Ğ°Ğ½Ğ¸   â”‚
                         â”‚ Ñ Ñ‚Ğ¾Ğ·Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»        â”‚
                         â”‚ (user_vehicles)         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ Ğ—Ğ° Ğ²ÑĞµĞºĞ¸ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»:    â”‚
                         â”‚ â€¢ Ğ¡ÑŠĞ·Ğ´Ğ°Ğ²Ğ° notification  â”‚
                         â”‚   Ğ·Ğ°Ğ¿Ğ¸Ñ (status=queued) â”‚
                         â”‚ â€¢ Ğ”Ğ¾Ğ±Ğ°Ğ²Ñ job Ğ² Ğ¾Ğ¿Ğ°ÑˆĞºĞ°   â”‚
                         â”‚   Ğ·Ğ° Ğ¸Ğ·Ğ¿Ñ€Ğ°Ñ‰Ğ°Ğ½Ğµ          â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ Ğ—Ğ°Ğ¿Ğ¸ÑĞ²Ğ° audit log:      â”‚
                         â”‚ â€¢ action: create_sessionâ”‚
                         â”‚ â€¢ entity_id: session_id â”‚
                         â”‚ â€¢ user_id: admin_id     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ ĞŸĞ¾ĞºĞ°Ğ·Ğ²Ğ° ÑÑŠĞ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ:      â”‚
                         â”‚ "Ğ—Ğ°Ñ€ĞµĞ¶Ğ´Ğ°Ğ½Ğµ ÑÑŠĞ·Ğ´Ğ°Ğ´ĞµĞ½Ğ¾.   â”‚
                         â”‚  ĞĞ¾Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¸Ğ·Ğ¿Ñ€Ğ°Ñ‚ĞµĞ½Ğ°."â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Pseudocode

```typescript
async function createChargeSession(adminId: string, data: CreateSessionDTO): Promise<ChargeSession> {
  // 1. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ½Ğ¸Ñ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ğ¸
  validateSessionData(data);
  
  // 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ğ»Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŠÑ‚ ÑÑŠÑ‰ĞµÑÑ‚Ğ²ÑƒĞ²Ğ° Ğ¸ Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½
  const vehicle = await db.vehicles.findOne({
    where: { id: data.vehicleId, status: 'active' }
  });
  
  if (!vehicle) {
    throw new Error('Vehicle not found or inactive');
  }
  
  // 3. ĞĞ°Ğ¼Ğ¸Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¾Ñ‚Ğ¾ Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚ÑŠÑ€ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ
  const lastOdometerReading = await db.odometerReadings.findOne({
    where: { vehicleId: vehicle.id },
    orderBy: { readingAt: 'DESC' }
  });
  
  const lastKnownKm = lastOdometerReading?.readingKm || 0;
  
  // 4. Ğ˜Ğ·Ñ‡Ğ¸ÑĞ»ÑĞ²Ğ°Ğ½Ğµ Ğ½Ğ° Ñ†ĞµĞ½Ğ° Ğ·Ğ° kWh (Ğ°ĞºĞ¾ Ğ½Ğµ Ğµ Ğ¿Ğ¾Ğ´Ğ°Ğ´ĞµĞ½Ğ°)
  const pricePerKwh = data.tariffId 
    ? (await db.tariffs.findOne({ where: { id: data.tariffId } })).pricePerKwh
    : data.priceTotal / data.kwhCharged;
  
  // 5. Ğ—Ğ°Ğ¿Ğ¾Ñ‡Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ
  const session = await db.transaction(async (trx) => {
    // Ğ¡ÑŠĞ·Ğ´Ğ°Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° ÑĞµÑĞ¸ÑÑ‚Ğ°
    const newSession = await trx.chargeSessions.create({
      data: {
        vehicleId: vehicle.id,
        stationId: data.stationId,
        tariffId: data.tariffId,
        startedAt: data.startedAt,
        endedAt: data.endedAt,
        kwhCharged: data.kwhCharged,
        priceTotal: data.priceTotal,
        pricePerKwh: pricePerKwh,
        currency: 'BGN',
        status: 'pending_odometer',
        notes: data.notes,
        createdBy: adminId
      }
    });
    
    // 6. ĞĞ°Ğ¼Ğ¸Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° Ğ²ÑĞ¸Ñ‡ĞºĞ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¸ ÑˆĞ¾Ñ„ÑŒĞ¾Ñ€Ğ¸ Ğ·Ğ° Ñ‚Ğ¾Ğ·Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»
    const assignedUsers = await trx.userVehicles.findMany({
      where: {
        vehicleId: vehicle.id,
        OR: [
          { assignedUntil: null },
          { assignedUntil: { gt: new Date() } }
        ]
      },
      include: { user: true }
    });
    
    // 7. Ğ¡ÑŠĞ·Ğ´Ğ°Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° Ğ½Ğ¾Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
    for (const assignment of assignedUsers) {
      await trx.notifications.create({
        data: {
          userId: assignment.userId,
          sessionId: newSession.id,
          type: 'odometer_request',
          subject: `ĞĞ¾Ğ²Ğ¾ Ğ·Ğ°Ñ€ĞµĞ¶Ğ´Ğ°Ğ½Ğµ Ğ·Ğ° ${vehicle.registrationNo}`,
          body: generateOdometerRequestBody(vehicle, newSession, lastKnownKm),
          status: 'queued',
          metadata: {
            vehicleId: vehicle.id,
            lastKnownKm: lastKnownKm,
            sessionId: newSession.id
          }
        }
      });
      
      // Ğ”Ğ¾Ğ±Ğ°Ğ²ÑĞ½Ğµ Ğ² job queue Ğ·Ğ° Ğ¸Ğ·Ğ¿Ñ€Ğ°Ñ‰Ğ°Ğ½Ğµ
      await jobQueue.add('send-notification', {
        userId: assignment.userId,
        sessionId: newSession.id,
        type: 'odometer_request'
      });
    }
    
    // 8. Audit log
    await trx.auditLogs.create({
      data: {
        userId: adminId,
        action: 'create_session',
        entityType: 'charge_session',
        entityId: newSession.id,
        changes: { created: newSession },
        ipAddress: getClientIp(),
        userAgent: getUserAgent()
      }
    });
    
    return newSession;
  });
  
  return session;
}

function generateOdometerRequestBody(vehicle: Vehicle, session: ChargeSession, lastKnownKm: number): string {
  return `
Ğ—Ğ´Ñ€Ğ°Ğ²ĞµĞ¹Ñ‚Ğµ,

Ğ˜Ğ¼Ğ° Ğ½Ğ¾Ğ²Ğ¾ Ğ·Ğ°Ñ€ĞµĞ¶Ğ´Ğ°Ğ½Ğµ Ğ·Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ» ${vehicle.make} ${vehicle.model} (${vehicle.registrationNo}).

ğŸ“ Ğ”Ğ°Ğ½Ğ½Ğ¸ Ğ·Ğ° Ğ·Ğ°Ñ€ĞµĞ¶Ğ´Ğ°Ğ½ĞµÑ‚Ğ¾:
â€¢ Ğ”Ğ°Ñ‚Ğ°: ${formatDate(session.startedAt)}
â€¢ Ğ—Ğ°Ñ€ĞµĞ´ĞµĞ½Ğ¸: ${session.kwhCharged} kWh
â€¢ Ğ¦ĞµĞ½Ğ°: ${session.priceTotal} Ğ»Ğ².

ğŸ“Š ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¸ ĞºĞ¸Ğ»Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ¸: ${lastKnownKm} ĞºĞ¼

ĞœĞ¾Ğ»Ñ, Ğ²ÑŠĞ²ĞµĞ´ĞµÑ‚Ğµ Ñ‚ĞµĞºÑƒÑ‰Ğ¾Ñ‚Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚ÑŠÑ€Ğ°, Ğ·Ğ° Ğ´Ğ° Ğ¸Ğ·Ñ‡Ğ¸ÑĞ»Ğ¸Ğ¼ Ñ€Ğ°Ğ·Ñ…Ğ¾Ğ´Ğ°.

ğŸ‘‰ Ğ’ÑŠĞ²ĞµĞ´ĞµÑ‚Ğµ Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚ÑŠÑ€: [LINK]

Ğ¡ ÑƒĞ²Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ,
Ğ•Car Fleet System
  `.trim();
}
```

### 2ï¸âƒ£ Ğ’ÑŠĞ²ĞµĞ¶Ğ´Ğ°Ğ½Ğµ Ğ½Ğ° Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚ÑŠÑ€ (Ğ¾Ñ‚ ÑˆĞ¾Ñ„ÑŒĞ¾Ñ€)

#### Flowchart

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨Ğ¾Ñ„ÑŒĞ¾Ñ€ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ğ²Ğ° email Ğ½Ğ¾Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ Ğ»Ğ¸Ğ½Ğº        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ĞÑ‚Ğ²Ğ°Ñ€Ñ Ğ»Ğ¸Ğ½ĞºĞ° â†’ Ğ¿Ñ€ĞµĞ½Ğ°ÑĞ¾Ñ‡Ğ²Ğ°Ğ½Ğµ ĞºÑŠĞ¼                 â”‚
â”‚ /driver/odometer-entry/:sessionId               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ—Ğ°Ñ€ĞµĞ¶Ğ´Ğ° ÑĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ:               â”‚
â”‚ â€¢ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ» (Ğ¼Ğ°Ñ€ĞºĞ°, Ğ¼Ğ¾Ğ´ĞµĞ», Ñ€ĞµĞ³. Ğ½Ğ¾Ğ¼ĞµÑ€)          â”‚
â”‚ â€¢ Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ° Ğ·Ğ°Ñ€ĞµĞ¶Ğ´Ğ°Ğ½Ğµ                             â”‚
â”‚ â€¢ kWh Ğ·Ğ°Ñ€ĞµĞ´ĞµĞ½Ğ¸                                  â”‚
â”‚ â€¢ Ğ¦ĞµĞ½Ğ°                                          â”‚
â”‚ â€¢ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¸ ĞºĞ¸Ğ»Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ¸                   â”‚
â”‚ â€¢ ĞŸĞ¾Ğ»Ğµ Ğ·Ğ° Ğ²ÑŠĞ²ĞµĞ¶Ğ´Ğ°Ğ½Ğµ Ğ½Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸ ĞºĞ¸Ğ»Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ¸         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨Ğ¾Ñ„ÑŒĞ¾Ñ€ÑŠÑ‚ Ğ²ÑŠĞ²ĞµĞ¶Ğ´Ğ°: current_km                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ (client-side):                        â”‚
â”‚ âœ“ current_km > last_known_km                    â”‚
â”‚ âœ“ current_km - last_known_km < MAX_DIFF (2000)  â”‚
â”‚ âœ“ current_km Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚               â”‚
            ĞĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾        Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾
                 â”‚               â”‚
                 â–¼               â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ ĞŸĞ¾ĞºĞ°Ğ·Ğ²Ğ° Ğ³Ñ€ĞµÑˆĞºĞ¸ â”‚  â”‚ Ğ˜Ğ·Ğ¿Ñ€Ğ°Ñ‰Ğ° POST Ğ·Ğ°ÑĞ²ĞºĞ°     â”‚
     â”‚ Ğ½Ğ° Ğ¿Ğ¾Ğ»ĞµÑ‚Ğ¾      â”‚  â”‚ ĞºÑŠĞ¼ API                 â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ Backend Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ:      â”‚
                         â”‚ â€¢ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ²Ğ°        â”‚
                         â”‚ â€¢ Ğ”ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°     â”‚
                         â”‚ â€¢ Ğ‘Ğ¸Ğ·Ğ½ĞµÑ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸      â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ Ğ—Ğ°Ğ¿Ğ¸ÑĞ²Ğ° Ğ² Ğ‘Ğ”:           â”‚
                         â”‚ â€¢ odometer_readings     â”‚
                         â”‚ â€¢ reading_km            â”‚
                         â”‚ â€¢ reading_at = NOW()    â”‚
                         â”‚ â€¢ entered_by = user_id  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ Trigger Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾:    â”‚
                         â”‚ â€¢ Ğ˜Ğ·Ñ‡Ğ¸ÑĞ»ÑĞ²Ğ° distance    â”‚
                         â”‚ â€¢ Ğ˜Ğ·Ñ‡Ğ¸ÑĞ»ÑĞ²Ğ° kWh/100km   â”‚
                         â”‚ â€¢ Ğ˜Ğ·Ñ‡Ğ¸ÑĞ»ÑĞ²Ğ° Ğ»Ğ²./100km   â”‚
                         â”‚ â€¢ ĞĞ±Ğ½Ğ¾Ğ²ÑĞ²Ğ° session      â”‚
                         â”‚   status = 'completed'  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ ĞĞ±Ğ½Ğ¾Ğ²ÑĞ²Ğ° notification:  â”‚
                         â”‚ â€¢ status = 'seen'       â”‚
                         â”‚ â€¢ seen_at = NOW()       â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ Audit log:              â”‚
                         â”‚ â€¢ action: enter_odometerâ”‚
                         â”‚ â€¢ entity: reading       â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ Ğ’Ñ€ÑŠÑ‰Ğ° ÑƒÑĞ¿ĞµÑˆĞµĞ½ Ñ€ĞµĞ·ÑƒĞ»Ñ‚Ğ°Ñ‚  â”‚
                         â”‚ Ñ Ğ¸Ğ·Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ‚Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ UI Ğ¿Ğ¾ĞºĞ°Ğ·Ğ²Ğ°:             â”‚
                         â”‚ âœ“ "ĞĞ´Ğ¾Ğ¼ĞµÑ‚ÑŠÑ€ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½"    â”‚
                         â”‚ â€¢ Ğ˜Ğ·Ğ¼Ğ¸Ğ½Ğ°Ñ‚Ğ¸: X km        â”‚
                         â”‚ â€¢ Ğ Ğ°Ğ·Ñ…Ğ¾Ğ´: Y kWh/100km   â”‚
                         â”‚ â€¢ Ğ¦ĞµĞ½Ğ°: Z Ğ»Ğ²./100km     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Pseudocode

```typescript
async function submitOdometerReading(
  userId: string,
  sessionId: string,
  currentKm: number
): Promise<OdometerReadingResult> {
  
  // 1. ĞĞ°Ğ¼Ğ¸Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° ÑĞµÑĞ¸ÑÑ‚Ğ°
  const session = await db.chargeSessions.findOne({
    where: { id: sessionId },
    include: { vehicle: true }
  });
  
  if (!session) {
    throw new Error('Session not found');
  }
  
  if (session.status !== 'pending_odometer') {
    throw new Error('Session is not pending odometer reading');
  }
  
  // 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ğ»Ğ¸ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»ÑÑ‚ Ğ¸Ğ¼Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ·Ğ° Ñ‚Ğ¾Ğ·Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»
  const hasAccess = await db.userVehicles.exists({
    where: {
      userId: userId,
      vehicleId: session.vehicleId,
      OR: [
        { assignedUntil: null },
        { assignedUntil: { gt: new Date() } }
      ]
    }
  });
  
  if (!hasAccess) {
    throw new ForbiddenError('You do not have access to this vehicle');
  }
  
  // 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ğ»Ğ¸ Ğ²ĞµÑ‡Ğµ Ğ¸Ğ¼Ğ° Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚ÑŠÑ€ Ğ·Ğ° Ñ‚Ğ°Ğ·Ğ¸ ÑĞµÑĞ¸Ñ
  const existingReading = await db.odometerReadings.findOne({
    where: { sessionId: sessionId }
  });
  
  if (existingReading) {
    throw new Error('Odometer reading already submitted for this session');
  }
  
  // 4. ĞĞ°Ğ¼Ğ¸Ñ€Ğ°Ğ½Ğµ Ğ½Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¾Ñ‚Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ
  const previousReading = await db.odometerReadings.findOne({
    where: {
      vehicleId: session.vehicleId,
      readingAt: { lt: new Date() }
    },
    orderBy: { readingAt: 'DESC' }
  });
  
  const lastKnownKm = previousReading?.readingKm || 0;
  
  // 5. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸
  if (currentKm <= lastKnownKm) {
    throw new ValidationError(`Current km (${currentKm}) must be greater than last known km (${lastKnownKm})`);
  }
  
  const distance = currentKm - lastKnownKm;
  const MAX_REASONABLE_DISTANCE = 2000; // ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾
  
  if (distance > MAX_REASONABLE_DISTANCE) {
    throw new ValidationError(
      `Distance (${distance} km) seems unreasonably high. ` +
      `Maximum allowed: ${MAX_REASONABLE_DISTANCE} km. ` +
      `Please verify the odometer reading.`
    );
  }
  
  // 6. Ğ˜Ğ·Ñ‡Ğ¸ÑĞ»ÑĞ²Ğ°Ğ½Ğµ Ğ½Ğ° Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
  const kwhPer100km = (session.kwhCharged / distance) * 100;
  const costPer100km = (session.priceTotal / distance) * 100;
  
  // 7. Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ
  const result = await db.transaction(async (trx) => {
    // Ğ¡ÑŠĞ·Ğ´Ğ°Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° odometer reading
    const reading = await trx.odometerReadings.create({
      data: {
        vehicleId: session.vehicleId,
        sessionId: session.id,
        readingKm: currentKm,
        readingAt: new Date(),
        enteredBy: userId,
        isVerified: false, // Fleet manager Ğ¼Ğ¾Ğ¶Ğµ Ğ´Ğ° Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ° Ğ¿Ğ¾ÑĞ»Ğµ
        distanceFromPreviousKm: distance,
        kwhPer100km: kwhPer100km,
        costPer100km: costPer100km
      }
    });
    
    // ĞĞ±Ğ½Ğ¾Ğ²ÑĞ²Ğ°Ğ½Ğµ Ğ½Ğ° ÑĞµÑĞ¸ÑÑ‚Ğ°
    await trx.chargeSessions.update({
      where: { id: session.id },
      data: { status: 'completed' }
    });
    
    // ĞĞ±Ğ½Ğ¾Ğ²ÑĞ²Ğ°Ğ½Ğµ Ğ½Ğ° Ğ½Ğ¾Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸ÑÑ‚Ğ°
    await trx.notifications.updateMany({
      where: {
        sessionId: session.id,
        userId: userId,
        type: 'odometer_request'
      },
      data: {
        status: 'seen',
        seenAt: new Date()
      }
    });
    
    // Audit log
    await trx.auditLogs.create({
      data: {
        userId: userId,
        action: 'enter_odometer',
        entityType: 'odometer_reading',
        entityId: reading.id,
        changes: {
          sessionId: session.id,
          vehicleId: session.vehicleId,
          readingKm: currentKm,
          distance: distance,
          kwhPer100km: kwhPer100km,
          costPer100km: costPer100km
        },
        ipAddress: getClientIp(),
        userAgent: getUserAgent()
      }
    });
    
    return reading;
  });
  
  return {
    success: true,
    reading: result,
    metrics: {
      distanceKm: distance,
      kwhPer100km: roundTo2Decimals(kwhPer100km),
      costPer100km: roundTo2Decimals(costPer100km),
      totalKwh: session.kwhCharged,
      totalCost: session.priceTotal
    }
  };
}
```

## ğŸ“Š Ğ˜Ğ·Ñ‡Ğ¸ÑĞ»ÑĞ²Ğ°Ğ½Ğµ Ğ½Ğ° Ñ€Ğ°Ğ·Ñ…Ğ¾Ğ´ Ğ¸ KPI

### Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸

#### 1. Ğ˜Ğ·Ğ¼Ğ¸Ğ½Ğ°Ñ‚Ğ¸ ĞºĞ¸Ğ»Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ·Ğ°Ñ€ĞµĞ¶Ğ´Ğ°Ğ½Ğ¸ÑÑ‚Ğ°

```
distance_km = current_odometer_km - previous_odometer_km
```

#### 2. Ğ Ğ°Ğ·Ñ…Ğ¾Ğ´ Ğ½Ğ° ĞµĞ½ĞµÑ€Ğ³Ğ¸Ñ (kWh Ğ½Ğ° 100 ĞºĞ¼)

```
kwh_per_100km = (kwh_charged / distance_km) Ã— 100
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:**
- Ğ—Ğ°Ñ€ĞµĞ´ĞµĞ½Ğ¸: 45 kWh
- Ğ˜Ğ·Ğ¼Ğ¸Ğ½Ğ°Ñ‚Ğ¸: 250 km
- Ğ Ğ°Ğ·Ñ…Ğ¾Ğ´: (45 / 250) Ã— 100 = **18 kWh/100km**

#### 3. Ğ Ğ°Ğ·Ñ…Ğ¾Ğ´ Ğ½Ğ° Ğ¿Ğ°Ñ€Ğ¸ (Ğ»Ğ². Ğ½Ğ° 100 ĞºĞ¼)

```
cost_per_100km = (price_total / distance_km) Ã— 100
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:**
- Ğ¦ĞµĞ½Ğ°: 18 Ğ»Ğ².
- Ğ˜Ğ·Ğ¼Ğ¸Ğ½Ğ°Ñ‚Ğ¸: 250 km
- Ğ Ğ°Ğ·Ñ…Ğ¾Ğ´: (18 / 250) Ã— 100 = **7.20 Ğ»Ğ²./100km**

#### 4. Ğ¡Ñ€ĞµĞ´Ğ½Ğ° Ñ†ĞµĞ½Ğ° Ğ·Ğ° kWh

```
price_per_kwh = price_total / kwh_charged
```

#### 5. ĞĞ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ°Ğ½Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ·Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´

```sql
-- ĞĞ±Ñ‰ Ñ€Ğ°Ğ·Ñ…Ğ¾Ğ´ Ğ·Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ» Ğ·Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´
SELECT
    v.registration_no,
    COUNT(cs.id) as total_sessions,
    SUM(cs.kwh_charged) as total_kwh,
    SUM(cs.price_total) as total_cost,
    SUM(od.distance_from_previous_km) as total_distance_km,
    
    -- Ğ¡Ñ€ĞµĞ´Ğ½Ğ¾ Ğ¿Ñ€ĞµÑ‚ĞµĞ³Ğ»ĞµĞ½ Ñ€Ğ°Ğ·Ñ…Ğ¾Ğ´ (Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ĞµĞ½ Ğ½Ğ°Ñ‡Ğ¸Ğ½)
    CASE 
        WHEN SUM(od.distance_from_previous_km) > 0 
        THEN (SUM(cs.kwh_charged) / SUM(od.distance_from_previous_km)) * 100
        ELSE 0
    END as avg_kwh_per_100km,
    
    CASE 
        WHEN SUM(od.distance_from_previous_km) > 0 
        THEN (SUM(cs.price_total) / SUM(od.distance_from_previous_km)) * 100
        ELSE 0
    END as avg_cost_per_100km,
    
    -- Ğ¡Ñ€ĞµĞ´Ğ½Ğ° Ñ†ĞµĞ½Ğ° Ğ·Ğ° kWh
    CASE 
        WHEN SUM(cs.kwh_charged) > 0 
        THEN SUM(cs.price_total) / SUM(cs.kwh_charged)
        ELSE 0
    END as avg_price_per_kwh

FROM vehicles v
LEFT JOIN charge_sessions cs ON v.id = cs.vehicle_id
    AND cs.status = 'completed'
    AND cs.started_at BETWEEN :start_date AND :end_date
LEFT JOIN odometer_readings od ON cs.id = od.session_id
WHERE v.status = 'active'
GROUP BY v.id, v.registration_no
ORDER BY total_cost DESC;
```

### SQL Ğ·Ğ°ÑĞ²ĞºĞ¸ Ğ·Ğ° Ñ‡ĞµÑÑ‚Ğ¾ Ğ¸Ğ·Ğ¿Ğ¾Ğ»Ğ·Ğ²Ğ°Ğ½Ğ¸ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¸

#### 1. Ğ¢Ğ¾Ğ¿ 5 Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğ° Ğ¿Ğ¾ Ñ€Ğ°Ğ·Ñ…Ğ¾Ğ´ Ğ·Ğ° Ğ¼ĞµÑĞµÑ†

```sql
WITH monthly_stats AS (
    SELECT
        v.id,
        v.registration_no,
        v.make,
        v.model,
        SUM(cs.price_total) as total_cost,
        SUM(cs.kwh_charged) as total_kwh,
        SUM(od.distance_from_previous_km) as total_km,
        COUNT(cs.id) as session_count
    FROM vehicles v
    JOIN charge_sessions cs ON v.id = cs.vehicle_id
        AND cs.status = 'completed'
        AND DATE_TRUNC('month', cs.started_at) = DATE_TRUNC('month', CURRENT_DATE)
    JOIN odometer_readings od ON cs.id = od.session_id
    GROUP BY v.id, v.registration_no, v.make, v.model
)
SELECT
    registration_no,
    make || ' ' || model as vehicle,
    total_cost,
    total_kwh,
    total_km,
    session_count,
    ROUND((total_kwh / NULLIF(total_km, 0)) * 100, 2) as avg_kwh_per_100km,
    ROUND((total_cost / NULLIF(total_km, 0)) * 100, 2) as avg_cost_per_100km
FROM monthly_stats
ORDER BY total_cost DESC
LIMIT 5;
```

#### 2. Ğ•Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ Ğ¿Ğ¾ ÑˆĞ¾Ñ„ÑŒĞ¾Ñ€

```sql
SELECT
    u.full_name,
    u.email,
    COUNT(DISTINCT uv.vehicle_id) as vehicles_count,
    COUNT(cs.id) as total_sessions,
    SUM(cs.price_total) as total_spent,
    SUM(od.distance_from_previous_km) as total_km_driven,
    AVG(od.kwh_per_100km) as avg_consumption
FROM users u
JOIN user_vehicles uv ON u.id = uv.user_id
JOIN charge_sessions cs ON uv.vehicle_id = cs.vehicle_id
    AND cs.status = 'completed'
    AND cs.started_at >= :start_date
JOIN odometer_readings od ON cs.id = od.session_id
    AND od.entered_by = u.id
WHERE u.role = 'driver'
GROUP BY u.id, u.full_name, u.email
ORDER BY total_spent DESC;
```

#### 3. Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ¼ĞµÑĞµÑ†-ÑĞ¿Ñ€ÑĞ¼Ğ¾-Ğ¼ĞµÑĞµÑ† (MoM)

```sql
WITH monthly_totals AS (
    SELECT
        DATE_TRUNC('month', cs.started_at) as month,
        COUNT(cs.id) as sessions,
        SUM(cs.price_total) as total_cost,
        SUM(cs.kwh_charged) as total_kwh,
        SUM(od.distance_from_previous_km) as total_km
    FROM charge_sessions cs
    LEFT JOIN odometer_readings od ON cs.id = od.session_id
    WHERE cs.status = 'completed'
        AND cs.started_at >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '6 months')
    GROUP BY DATE_TRUNC('month', cs.started_at)
),
with_previous AS (
    SELECT
        month,
        sessions,
        total_cost,
        total_kwh,
        total_km,
        LAG(total_cost) OVER (ORDER BY month) as prev_month_cost,
        LAG(total_km) OVER (ORDER BY month) as prev_month_km
    FROM monthly_totals
)
SELECT
    TO_CHAR(month, 'YYYY-MM') as month,
    sessions,
    ROUND(total_cost, 2) as cost,
    ROUND(total_kwh, 2) as kwh,
    total_km as km,
    ROUND((total_cost / NULLIF(total_km, 0)) * 100, 2) as cost_per_100km,
    CASE
        WHEN prev_month_cost IS NOT NULL AND prev_month_cost > 0
        THEN ROUND(((total_cost - prev_month_cost) / prev_month_cost) * 100, 2)
        ELSE NULL
    END as cost_change_pct
FROM with_previous
ORDER BY month DESC;
```

#### 4. Pending Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ¸ (Ğ·Ğ° Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ½ÑĞ½Ğ¸Ñ)

```sql
SELECT
    cs.id,
    cs.created_at,
    v.registration_no,
    v.make,
    v.model,
    cs.started_at as charge_date,
    cs.kwh_charged,
    cs.price_total,
    u.full_name as driver_name,
    u.email as driver_email,
    EXTRACT(EPOCH FROM (NOW() - cs.created_at)) / 3600 as hours_pending
FROM charge_sessions cs
JOIN vehicles v ON cs.vehicle_id = v.id
JOIN user_vehicles uv ON v.id = uv.vehicle_id
    AND (uv.assigned_until IS NULL OR uv.assigned_until > NOW())
JOIN users u ON uv.user_id = u.id
WHERE cs.status = 'pending_odometer'
ORDER BY cs.created_at ASC;
```

## ğŸ”” Ğ‘Ğ¸Ğ·Ğ½ĞµÑ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°

### Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸ ÑÑŠĞ·Ğ´Ğ°Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° ÑĞµÑĞ¸Ñ

1. **Ğ”Ğ°Ñ‚Ğ¸:**
   - `ended_at >= started_at`
   - `started_at` Ğ½Ğµ Ğµ Ğ¿Ğ¾Ğ²ĞµÑ‡Ğµ Ğ¾Ñ‚ 30 Ğ´Ğ½Ğ¸ Ğ² Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ¾Ñ‚Ğ¾ (ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾)
   - `started_at` Ğ½Ğµ Ğµ Ğ² Ğ±ÑŠĞ´ĞµÑ‰ĞµÑ‚Ğ¾

2. **kWh:**
   - `kwh_charged > 0`
   - `kwh_charged <= vehicle.battery_capacity_kwh * 1.2` (120% Ğ¾Ñ‚ ĞºĞ°Ğ¿Ğ°Ñ†Ğ¸Ñ‚ĞµÑ‚Ğ° - Ğ·Ğ° Ğ·Ğ¸Ğ¼Ğ½Ğ¸ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ)

3. **Ğ¦ĞµĞ½Ğ°:**
   - `price_total >= 0`
   - ĞĞºĞ¾ Ğµ Ğ¿Ğ¾Ğ´Ğ°Ğ´ĞµĞ½Ğ° Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ°: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ğ»Ğ¸ `price_total â‰ˆ kwh_charged Ã— tariff.price_per_kwh` (Â±10% Ñ‚Ğ¾Ğ»ĞµÑ€Ğ°Ğ½Ñ)

4. **ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»:**
   - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŠÑ‚ Ñ‚Ñ€ÑĞ±Ğ²Ğ° Ğ´Ğ° Ğµ `status = 'active'`
   - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŠÑ‚ Ñ‚Ñ€ÑĞ±Ğ²Ğ° Ğ´Ğ° Ğ¸Ğ¼Ğ° Ğ¿Ğ¾Ğ½Ğµ ĞµĞ´Ğ¸Ğ½ assigned Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»

### Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸ Ğ²ÑŠĞ²ĞµĞ¶Ğ´Ğ°Ğ½Ğµ Ğ½Ğ° Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚ÑŠÑ€

1. **ĞšĞ¸Ğ»Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ¸:**
   - `current_km > last_known_km`
   - `current_km - last_known_km < MAX_DISTANCE` (Ğ½Ğ°Ğ¿Ñ€. 2000 km)
   - `current_km - last_known_km >= MIN_DISTANCE` (Ğ½Ğ°Ğ¿Ñ€. 1 km)

2. **ĞŸÑ€Ğ°Ğ²Ğ°:**
   - ĞŸĞ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»ÑÑ‚ Ñ‚Ñ€ÑĞ±Ğ²Ğ° Ğ´Ğ° Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½
   - ĞŸĞ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»ÑÑ‚ Ñ‚Ñ€ÑĞ±Ğ²Ğ° Ğ´Ğ° Ğµ ÑĞ²ÑŠÑ€Ğ·Ğ°Ğ½ Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğ° Ğ² `user_vehicles`
   - `assigned_until` Ğµ NULL Ğ¸Ğ»Ğ¸ Ğ² Ğ±ÑŠĞ´ĞµÑ‰ĞµÑ‚Ğ¾

3. **Ğ¡ÑŠÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ:**
   - Ğ¡ĞµÑĞ¸ÑÑ‚Ğ° Ñ‚Ñ€ÑĞ±Ğ²Ğ° Ğ´Ğ° Ğµ `status = 'pending_odometer'`
   - ĞĞµ Ñ‚Ñ€ÑĞ±Ğ²Ğ° Ğ´Ğ° ÑÑŠÑ‰ĞµÑÑ‚Ğ²ÑƒĞ²Ğ° Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚ÑŠÑ€ Ğ·Ğ° Ñ‚Ğ°Ğ·Ğ¸ ÑĞµÑĞ¸Ñ (no duplicate)

### Ğ‘Ğ¸Ğ·Ğ½ĞµÑ Ğ°Ğ»ĞµÑ€Ñ‚Ğ¸

1. **Ğ’Ğ¸ÑĞ¾Ğº Ñ€Ğ°Ğ·Ñ…Ğ¾Ğ´:**
   - ĞĞºĞ¾ `kwh_per_100km > 25` â†’ Ñ„Ğ»Ğ°Ğ³ Ğ·Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
   - ĞĞºĞ¾ `cost_per_100km > 15 BGN` â†’ Ñ„Ğ»Ğ°Ğ³ Ğ·Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°

2. **ĞĞµÑ€Ğ°Ğ·ÑƒĞ¼Ğ½Ğ¸ Ğ´Ğ°Ğ½Ğ½Ğ¸:**
   - ĞĞºĞ¾ Ğ¸Ğ·Ğ¼Ğ¸Ğ½Ğ°Ñ‚Ğ¸ ĞºĞ¸Ğ»Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ¸ > 500 Ğ·Ğ° ĞµĞ´Ğ½Ğ° ÑĞµÑĞ¸Ñ â†’ Ğ¸Ğ·Ğ¸ÑĞºĞ²Ğ° Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ fleet manager
   - ĞĞºĞ¾ Ñ€Ğ°Ğ·Ñ…Ğ¾Ğ´ < 5 kWh/100km â†’ Ğ²ÑŠĞ·Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ³Ñ€ĞµÑˆĞºĞ° Ğ² Ğ´Ğ°Ğ½Ğ½Ğ¸Ñ‚Ğµ

3. **Ğ—Ğ°Ğ±Ğ°Ğ²ĞµĞ½Ğ¸ Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ¸:**
   - Ğ¡Ğ»ĞµĞ´ 24 Ñ‡Ğ°ÑĞ° Ğ±ĞµĞ· Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚ÑŠÑ€ â†’ Ğ¿ÑŠÑ€Ğ²Ğ¾ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ½ÑĞ½Ğµ
   - Ğ¡Ğ»ĞµĞ´ 48 Ñ‡Ğ°ÑĞ° Ğ±ĞµĞ· Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚ÑŠÑ€ â†’ Ğ²Ñ‚Ğ¾Ñ€Ğ¾ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ½ÑĞ½Ğµ + Ğ½Ğ¾Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ´Ğ¾ fleet manager
   - Ğ¡Ğ»ĞµĞ´ 72 Ñ‡Ğ°ÑĞ° â†’ ĞµÑĞºĞ°Ğ»Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¾ admin

---

**Ğ¡Ğ»ĞµĞ´Ğ²Ğ°Ñ‰Ğ° ÑÑ‚ÑŠĞ¿ĞºĞ°:** ĞĞ¾Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°
